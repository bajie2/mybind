<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Life Game</title>
        <style type="text/css">
            html,
            body {}

            canvas {
                background-color: dimgrey;
            }

            .div1 {
                margin-bottom: 10px;
            }

            .stop {
                display: none;
            }

            .run .stop {
                display: inline;
            }

            .run .start {
                display: none;
            }

            button,
            select {
                width: 70px;
                height: 30px;
            }
        </style>
        <script type="text/plain" id="script1">
            T
x = 12, y = 10, rule = B3/S23
3o$bo$bo!
坦克
x = 39, y = 28, rule = B3/S23
2o$b2o$2o!
滑翔机
x = 10, y = 41, rule = B3/S23
3o$2bo$bo!
凤凰
x = 1, y = 1, rule = B3/S23
3bo$3bobo$bo$6b2o$2o$6bo$2bobo$4bo!
脉冲星
x = 29, y = 11, rule = B3/S23
2b2o5b2o$3b2o3b2o$o2bobobobo2bo$3ob2ob2ob3o$bobobobobobo$2b3o3b3o2$2b3o3b3o$bobobobobobo$3ob2ob2ob3o$o2bobobobo2bo$3b2o3b2o$2b2o5b2o!
滑翔机枪
x = 1, y = 1, rule = B3/S23
23bobo$21bo3bo$13bo7bo12b2o$12b4o4bo4bo8b2o$2o9b2obobo4bo$2o8b3obo2bo3bo3bo$11b2obobo6bobo$12b4o$13bo!            
        </script>
        <script type="text/javascript">
            var interval = 200; // 动画间隔毫秒
            var sizeCell = 10; // 格子大小
            var width = document.documentElement.clientWidth - 20; // 1400; // 画布宽
            var height = document.documentElement.clientHeight - 60; // 700; // 画布高
            var sizeX = Math.floor(width / (sizeCell + 1)); // 横向格数
            var sizeY = Math.floor(height / (sizeCell + 1)); // 纵向格数
            var data = new Array(sizeY);
            var data2 = new Array(sizeY);
            for (var y = 0; y < sizeY; y++) {
                data[y] = new Array(sizeX);
                data2[y] = new Array(sizeX);
            }
            var cxt;
            var isRun = false;
            var nextStep = false;

            function parseScript1() {
                var s = document.getElementById('script1').innerHTML;
                var arr = s.split("\n");
                var result = {};
                var index = 0;
                var o;
                for (var i = 0; i < arr.length; i++) {
                    var line = arr[i].trim();
                    if (!line) {
                        continue;
                    }
                    index++;
                    switch (index) {
                        case 1:
                            o = {};
                            o.text = line;
                            break;
                        case 2:
                            o.data = line;
                            break;
                        case 3:
                            o.data += "\n" + line;
                            result[o.text] = o;
                            index = 0;
                            break;
                    }
                }
                var list = document.getElementsByTagName("select")[0];
                list.data = result;
                for (var i in result) {
                    o = document.createElement("option");
                    o.text = i;
                    list.options.add(o);
                }
            }

            function preset(type) {
                var list = document.getElementsByTagName("select")[0];
                switch (type) {
                    case "随机":
                        for (var y = 0; y < sizeY; y++) {
                            for (var x = 0; x < sizeX; x++) {
                                data[y][x] = Math.round(Math.random() * 100) % 5 == 1 ? 1 : 0;
                            }
                        }
                        break;
                    default:
                        let s = list.data[type].data;
                        if (!s) {
                            return;
                        }
                        pushData(s);
                        break;
                }
            }

            function render() {
                cxt.clearRect(0, 0, width, height);
                for (var y = 0; y < sizeY; y++) {
                    for (var x = 0; x < sizeX; x++) {
                        var value = data[y][x];
                        cxt.fillStyle = value == 1 ? "#000000" : "#ffffff";
                        var left = 1 + x * (sizeCell + 1);
                        var top = 1 + y * (sizeCell + 1);
                        cxt.fillRect(left, top, sizeCell, sizeCell);
                    }
                }
            }

            function work() {
                if (isRun || nextStep) {
                    for (let y = 0; y < sizeY; y++) {
                        for (let x = 0; x < sizeX; x++) {
                            let count = 0
                            for (let y2 = y - 1; y2 <= y + 1; y2++) {
                                for (let x2 = x - 1; x2 <= x + 1; x2++) {
                                    if (y2 < 0 || x2 < 0 || y2 >= sizeY || x2 >= sizeX) {
                                        continue;
                                    }
                                    count += data[y2][x2];
                                }
                            }
                            count -= data[y][x];
                            if (count == 3) {
                                data2[y][x] = 1
                            } else if (count != 2) {
                                data2[y][x] = 0
                            } else {
                                data2[y][x] = data[y][x];
                            }
                        }
                    }
                    let swap = data;
                    data = data2;
                    data2 = swap;
                    if (nextStep) {
                        nextStep = false;
                    }
                }
                //
                render();
                //
                setTimeout(work, interval);
            }

            function btnStart_click() {
                var div = document.querySelector(".div1");
                if (isRun) {
                    isRun = false;
                    div.classList.remove("run");
                } else {
                    isRun = true;
                    div.classList.add("run");
                }
            }

            function select_click(list) {
                if (isRun) {
                    btnStart_click();
                }
                var type = list.options[list.selectedIndex].text;
                preset(type);
            }
            window.onload = function() {
                var canvas = document.getElementsByTagName('canvas')[0];
                canvas.width = width;
                canvas.height = height;
                cxt = canvas.getContext("2d");
                parseScript1();
                preset("随机");
                setTimeout(work, interval);
            };
            let leftButtonDown = false;

            function canvas_mouseUp(event) {
                leftButtonDown = false;
            }

            function canvas_mouseDown(event, isDown) {
                event.preventDefault();
                if (isDown && event.button == 0) {
                    leftButtonDown = true;
                }
                if (!leftButtonDown) {
                    return;
                }
                if (isRun) {
                    btnStart_click();
                }
                var x = event.offsetX;
                var y = event.offsetY;
                var xCell = Math.floor(x / (sizeCell + 1));
                var yCell = Math.floor(y / (sizeCell + 1));
                if (isDown) {
                    data[yCell][xCell] = data[yCell][xCell] == 1 ? 0 : 1;
                } else {
                    data[yCell][xCell] = 1;
                }
            }

            function btnStep_click() {
                if (isRun) {
                    btnStart_click();
                }
                nextStep = true;
            }

            function btnClear_click() {
                if (isRun) {
                    btnStart_click();
                }
                for (let y = 0; y < sizeY; y++) {
                    for (let x = 0; x < sizeX; x++) {
                        data[y][x] = 0;
                    }
                }
            }

            function btnCopy_click() {
                let s = getData();
                copy(s);
            }

            function btnPaste_click() {
                let s = paste();
            }

            function body_onkeydown(event) {
                if (event.keyCode == 9) { // Tab
                    btnStep_click();
                    event.preventDefault();
                } else if (event.keyCode == 13) { // Enter
                    btnStart_click();
                    event.preventDefault();
                } else if (event.keyCode == 67 && event.ctrlKey) { // Ctrl+C
                    btnCopy_click();
                    event.preventDefault();
                } else if (event.keyCode == 86 && event.ctrlKey) { // Ctrl+V
                    //btnPaste_click();
                    //event.preventDefault();
                } else if (event.keyCode == 46) { // Delete
                    btnClear_click();
                    event.preventDefault();
                }
                // console.log(event.keyCode, event.ctrlKey);
            }

            function getData() {
                var left = 0;
                var top = 0;
                Label1:
                    for (let y = 0; y < sizeY; y++) {
                        for (let x = 0; x < sizeX; x++) {
                            if (data[y][x] > 0) {
                                top = y;
                                break Label1;
                            }
                        }
                    }
                Label2:
                    for (let x = 0; x < sizeX; x++) {
                        for (let y = 0; y < sizeY; y++) {
                            if (data[y][x] > 0) {
                                left = x;
                                break Label2;
                            }
                        }
                    }
                var result = [];
                result.push(`x = ${left}, y = ${top}, rule = B3/S23\n`);
                var line = [];
                var v;
                var count;
                var v2 = null;
                var count2 = 0;

                function pushItem() {
                    var s = "bo".charAt(v);
                    if (count > 1) {
                        s = count + s;
                    }
                    line.push(s);
                }

                function pushItem2() {
                    if (result.length > 1) {
                        var s = "$";
                        if (count2 > 1) {
                            s = count2 + s;
                        }
                        result.push(s);
                    }
                    result.push(line.join(""));
                }
                for (let y = top; y < sizeY; y++) {
                    v = data[y][left];
                    count = 0;
                    line = [];
                    for (let x = left; x < sizeX; x++) {
                        if (data[y][x] == v) {
                            count++;
                        } else {
                            pushItem();
                            v = data[y][x];
                            count = 1;
                        }
                    }
                    if (v > 0) {
                        pushItem();
                    }
                    var empty = line.length == 0;
                    if (empty) {
                        count2++;
                    } else {
                        pushItem2();
                        count2 = 1;
                    }
                    v2 = empty;
                }
                result.push("!");
                return result.join("");
            }

            function pushData(s) {
                if (!s) {
                    return;
                }
                s = s.trim();
                if (!s.match(/!$/)) {
                    return;
                }
                btnClear_click();
                var p = s.indexOf("\n");
                var left = 0;
                var top = 0;
                var match;
                if (p > 0) {
                    var s2 = s.substr(0, p);
                    match = s2.match(/x\s*=\s*(\d+),\s*y\s*=\s*(\d+)/);
                    left = parseInt(match[1]);
                    top = parseInt(match[2]);
                }
                s = s.substring(p + 1, s.length - 1);
                let x = left;
                let y = top;
                var arr = s.split("$");
                var reg = /(\d*)([bo])/g;
                var count;
                for (let i = 0; i < arr.length; i++) {
                    let line = arr[i];
                    while (true) {
                        match = reg.exec(line);
                        if (!match) {
                            break;
                        }
                        count = match[1] || 1;
                        var value = match[2] == "o" ? 1 : 0
                        for (let j = 0; j < count; j++) {
                            data[y][x++] = value;
                            if (x >= sizeX) {
                                break;
                            }
                        }
                    }
                    match = line.match(/\d+$/);
                    count = match ? parseInt(match[0]) : 1;
                    x = left;
                    y += count;
                    if (y >= sizeY) {
                        console.log('out y=', y, sizeY)
                        break;
                    }
                }
            }

            function copy(s) {
                document.oncopy = function(e) {
                    e.clipboardData.setData('text', s);
                    e.preventDefault();
                    document.oncopy = null;
                }
                document.execCommand('Copy');
            }

            function paste() {
                alert("不会写...\n请用Ctrl+V");
                document.execCommand('Paste');
            }

            function body_onpaste(event) {
                var item = event.clipboardData.items[0];
                if (item.kind === "string") {
                    item.getAsString(function(s) {
                        pushData(s);
                    });
                }
            }
        </script>
    </head>
    <body onkeydown="body_onkeydown(event);" onpaste="body_onpaste(event)">
        <div class='div1'>
            <button class="start" onclick="btnStart_click();" title="(Enter)">开始</button>
            <button class="stop" onclick="btnStart_click();" title="(Enter)">停止</button>
            <button onclick="btnStep_click();" title="(Tab)">单步</button>
            <button onclick="btnClear_click();" title="(Delete)">清空</button>
            <button onclick="btnCopy_click();" title="(Ctrl+C)">复制</button>
            <button onclick="btnPaste_click();" title="(Ctrl+V)">粘贴</button>
            <select onchange="select_click(this);">
                <option>随机</option>
            </select>
        </div>
        <canvas onmousemove="canvas_mouseDown(event);" onmousedown="canvas_mouseDown(event,true);" onmouseup="canvas_mouseUp(event);"></canvas>
    </body>
</html>
