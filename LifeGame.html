<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>Life Game</title>
		<style type="text/css">
			html,
			body {}

			canvas {
				background-color: dimgrey;
			}

			.div1 {
				margin-bottom: 10px;
			}
			.stop{
				display: none;
			}
			.run .stop{
				display: inline;
			}
			.run .start{
				display: none;
			}
			button,
			select {
				width: 90px;
				height: 30px;
			}
		</style>
		<script type="text/javascript">
			var interval = 250; // 动画间隔毫秒
			var sizeCell = 15; // 格子大小
			var width = 1400; // 画布宽
			var height = 700; // 画布高
			var sizeX = Math.floor(width / (sizeCell + 1)); // 横向格数
			var sizeY = Math.floor(height / (sizeCell + 1)); // 纵向格数
			var data = new Array(sizeY);
			var data2 = new Array(sizeY);
			for (var y = 0; y < sizeY; y++) {
				data[y] = new Array(sizeX);
				data2[y] = new Array(sizeX);
			}
			var cxt;
			var isRun = false;
			var nextStep = false;

			function preset(type) {
				switch (type) {
					case "随机":
						for (var y = 0; y < sizeY; y++) {
							for (var x = 0; x < sizeX; x++) {
								data[y][x] = Math.round(Math.random() * 100) % 5 == 1 ? 1 : 0;
							}
						}
						break;
					case "空白":
						for (var y = 0; y < sizeY; y++) {
							for (var x = 0; x < sizeX; x++) {
								data[y][x] = 0;
							}
						}
						break;
				}
			}

			function render() {
				cxt.clearRect(0, 0, width, height);
				for (var y = 0; y < sizeY; y++) {
					for (var x = 0; x < sizeX; x++) {
						var value = data[y][x];
						cxt.fillStyle = value == 1 ? "#000000" : "#ffffff";
						var left = 1 + x * (sizeCell + 1);
						var top = 1 + y * (sizeCell + 1);
						cxt.fillRect(left, top, sizeCell, sizeCell);
					}
				}
			}

			function work() {
				if (isRun || nextStep) {
					data2 = new Array(sizeY);
					for (let y = 0; y < sizeY; y++) {
						data2[y] = new Array(sizeX);
						for (let x = 0; x < sizeX; x++) {
							let count = getCount(x, y);
							if (count == 3) {
								data2[y][x] = 1
							} else if (count != 2) {
								data2[y][x] = 0
							} else {
								data2[y][x] = data[y][x];
							}
						}
					}
					data = data2;
					if (nextStep) {
						nextStep = false;
					}
				}
				//
				render();
				//
				setTimeout(work, interval);
			}

			function getCount(x, y) {
				let count = 0;
				count += getCellValue(y, x + 1);
				count += getCellValue(y, x - 1);
				count += getCellValue(y + 1, x);
				count += getCellValue(y - 1, x);
				count += getCellValue(y + 1, x + 1);
				count += getCellValue(y + 1, x - 1);
				count += getCellValue(y - 1, x + 1);
				count += getCellValue(y - 1, x - 1);
				return count;
			}

			function getCellValue(y, x) {
				if (x < 0 || y < 0 || x >= sizeX || y >= sizeY) {
					return 0;
				}
				return data[y][x];
			}

			function btnStart_click() {
				var div=document.querySelector(".div1");
				if (isRun) {
					isRun = false;
					div.classList.remove("run");
				} else {
					isRun = true;
					div.classList.add("run");
				}
			}

			function select_click(list) {
				isRun = false;
				var type = list.options[list.selectedIndex].text;
				console.log(type);
				preset(type);
			}
			window.onload = function() {
				var canvas = document.getElementsByTagName('canvas')[0];
				canvas.width = width;
				canvas.height = height;
				cxt = canvas.getContext("2d");
				width = canvas.clientWidth;
				height = canvas.clientHeight;
				sizeX = Math.floor(width / (sizeCell + 1));
				sizeY = Math.floor(height / (sizeCell + 1));
				preset("随机");
				setTimeout(work, interval);
			};

			function canvas_mouseDown(event) {
				if (isRun) {
					btnStart_click();
				}
				var x = event.offsetX;
				var y = event.offsetY;
				var xCell = Math.floor(x / (sizeCell + 1));
				var yCell = Math.floor(y / (sizeCell + 1));
				data[yCell][xCell] = data[yCell][xCell] == 1 ? 0 : 1;
			}

			function body_onkeydown(event) {
				if (event.keyCode == 9) { // Tab
					if (isRun) {
						btnStart_click();
					}
					nextStep = true;
					event.preventDefault();
				}else if (event.keyCode == 13) { // Enter
					btnStart_click();
					event.preventDefault();
				}
				// console.log(event.keyCode);
			}
		</script>
	</head>
	<body onkeydown="body_onkeydown(event);">
		<div class='div1'>
			<button class="start" onclick="btnStart_click();" title="(Enter)">开始</button>
			<button class="stop" onclick="btnStart_click();" title="(Enter)">停止</button>
			<select onchange="select_click(this);">
				<option>随机</option>
				<option>空白</option>
			</select>
			<span>鼠标左键设置方块，按Tab键运行一步。</span>
		</div>
		<canvas onmousedown="canvas_mouseDown(event);"></canvas>
	</body>
</html>
